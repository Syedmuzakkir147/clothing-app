import React, { useState, useContext, useMemo, useEffect } from "react";
import { Modal, Button, Select, Drawer, Card, Row, Col } from "antd";
import { SearchOutlined } from "@ant-design/icons";
import { useNavigate, useSearchParams } from "react-router-dom";
import { CartContext } from "./context/CartContext";
import "./homePage.css";
import axios from "axios";

const HomePage = () => {
  const [category, setCategory] = useState("All");
  const [type, setType] = useState("All");
  const [selectedProduct, setSelectedProduct] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isDrawerOpen, setIsDrawerOpen] = useState(false);
  const navigate = useNavigate();

  const [options, setOptions] = useState([]);
  const [searchParams, setSearchParams] = useSearchParams();
  const search = searchParams.get("search") || "";

  const { cart, addCart, removeCart, updateCart } = useContext(CartContext);

  const [products, setProducts] = useState([]);

  const fetchProducts = async () => {
    try {
      const res = await axios.get("http://localhost:3005/products", {
        params: { search: search || undefined },
      });
      console.log(res);
      setProducts(res.data.product);
    } catch (error) {
      console.error("Error fetching products:", error);
    }
  };

  useEffect(() => {
    fetchProducts();
  }, [search]);

  const filteredProducts = useMemo(() => {
    return products.filter(
      (p) =>
        (category === "All" || p.category === category) &&
        (type === "All" || p.type === type)
    );
  }, [category, type, products, search]);

  const handleAddToCart = async (product) => {
    await addCart(product);

    setIsModalOpen(false);
  };

  const handleSearch = async (value) => {
    if (!value) {
      setOptions([]);
      setSearchParams({});
      return;
    }

    try {
      const res = await axios.get("http://localhost:3005/products", {
        params: { search: value },
      });
      const suggestions = res.data.product.map((item) => ({
        value: item.name,
      }));
      setOptions(suggestions);
    } catch (error) {
      console.log("Error fetching suggestions", error);
    }
    setSearchParams({ search: value });
  };

  const handleSelect = (value) => {
    setSearchParams({ search: value });
  };

  const { Option } = Select;

  return (
    <div className="home">
      <div className="navbar">
        <h2 className="logo">FlopKart</h2>

        <Button type="primary" onClick={() => setIsDrawerOpen(true)}>
          ðŸ›’ Cart ({cart.length})
        </Button>
      </div>

      <div className="filters">
        <Button type="dashed" onClick={() => navigate("/products")}>
          Product
        </Button>

        <Select
          showSearch
          placeholder="Search for products, brands and more"
          value={search}
          onSearch={handleSearch}
          onSelect={handleSelect}
          options={options}
          style={{
            width: 400,
            borderRadius: "25px",
          }}
          className="search-bar"
          suffixIcon={<SearchOutlined style={{ fontSize: 18 }} />}
        />

        <Select value={category} onChange={setCategory} style={{ width: 160 }}>
          <Option value="All">All Categories</Option>
          <Option value="Men">Men</Option>
          <Option value="Women">Women</Option>
          <Option value="Kids">Kids</Option>
        </Select>

        <Select value={type} onChange={setType} style={{ width: 160 }}>
          <Option value="All">All Types</Option>
          <Option value="Tshirt">Tshirt</Option>
          <Option value="Shirt">Shirt</Option>
          <Option value="Pant">Pant</Option>
          <Option value="Hoodie">Hoodie</Option>
        </Select>
      </div>

      <Row gutter={[20, 20]} className="product-grid">
        {filteredProducts.map((product) => (
          <Col xs={24} sm={12} md={8} lg={6} key={product._id}>
            <Card
              hoverable
              style={{
                borderRadius: 12,
                overflow: "hidden",
                boxShadow: "0 4px 16px rgba(0,0,0,0.08)",
              }}
              cover={
                <img
                  alt={product.name}
                  src={product.image}
                  style={{
                    height: 230,
                    width: "100%",
                    objectFit: "cover",
                  }}
                />
              }
            >
              <h3 style={{ marginBottom: 5 }}>{product.name}</h3>

              <p style={{ color: "gray", marginBottom: 15, fontSize: 15 }}>
                â‚¹{product.price}
              </p>

              <div style={{ display: "flex", gap: 10 }}>
                <Button
                  type="default"
                  block
                  onClick={() => navigate(`/details/${product._id}`)}
                >
                  View
                </Button>

                <Button
                  type="primary"
                  block
                  onClick={() => handleAddToCart(product)}
                >
                  Add
                </Button>
              </div>
            </Card>
          </Col>
        ))}
      </Row>

      <Modal
        title={selectedProduct?.name}
        open={isModalOpen}
        onCancel={() => setIsModalOpen(false)}
        footer={[
          <Button key="cancel" onClick={() => setIsModalOpen(false)}>
            Cancel
          </Button>,
          // <Button
          //   key="add"
          //   type="primary"
          //   onClick={() => handleAddToCart(selectedProduct)}
          // >
          //   Add to Cart
          // </Button>,
        ]}
      >
        {selectedProduct && (
          <div className="modal-content">
            <img
              src={selectedProduct.image}
              alt={selectedProduct.name}
              className="modal-image"
            />
            <p>
              <b>Category:</b> {selectedProduct.category}
            </p>
            <p>
              <b>Type:</b> {selectedProduct.type}
            </p>
            <p>
              <b>Price:</b> â‚¹{selectedProduct.price}
            </p>
          </div>
        )}
      </Modal>

      <Drawer
        title="Your Cart"
        placement="right"
        onClose={() => setIsDrawerOpen(false)}
        open={isDrawerOpen}
        width={380}
      >
        {!cart.length ? (
          <p>No items in cart</p>
        ) : (
          <div>
            {cart.map((item) => (
              <div
                key={item.productId}
                style={{
                  display: "flex",
                  alignItems: "center",
                  marginBottom: 20,
                  padding: 10,
                  borderRadius: 8,
                  background: "#fafafa",
                  border: "1px solid #eee",
                }}
              >
                <img
                  src={item.image}
                  alt={item.name}
                  style={{
                    width: 70,
                    height: 70,
                    borderRadius: 8,
                    objectFit: "cover",
                    marginRight: 15,
                  }}
                />

                <div style={{ flex: 1 }}>
                  <h4 style={{ margin: 0 }}>{item.name}</h4>
                  <p style={{ margin: "5px 0", color: "#666" }}>
                    â‚¹{item.price}
                  </p>

                  <div style={{ display: "flex", alignItems: "center" }}>
                    <Button
                      size="small"
                      onClick={() =>
                        updateCart(item.productId, item.quantity - 1)
                      }
                      disabled={item.quantity <= 1}
                    >
                      -
                    </Button>

                    <span style={{ margin: "0 10px" }}>{item.quantity}</span>

                    <Button
                      size="small"
                      onClick={() =>
                        updateCart(item.productId, item.quantity + 1)
                      }
                    >
                      +
                    </Button>
                  </div>
                </div>

                <Button
                  danger
                  size="small"
                  onClick={() => removeCart(item.productId)}
                  style={{ marginLeft: 10 }}
                >
                  Remove
                </Button>
              </div>
            ))}

            <div
              style={{
                borderTop: "1px solid #ddd",
                paddingTop: 15,
                marginTop: 20,
                fontSize: 16,
                fontWeight: "bold",
              }}
            >
              Total: â‚¹
              {cart.reduce((acc, item) => acc + item.price * item.quantity, 0)}
            </div>

            <Button
              type="primary"
              block
              style={{ marginTop: 20, height: 45, fontSize: 16 }}
              onClick={() => navigate("/checkout")}
            >
              Proceed to Checkout
            </Button>
          </div>
        )}
      </Drawer>

      <footer className="footer">
        <div className="footer-container">
          <div className="footer-section">
            <h3>Available Categories</h3>
            <ul>
              <li>Men</li>
              <li>Women</li>
              <li>Kids</li>
              <li>Accessories</li>
              <li>Footwear</li>
            </ul>
          </div>

          <div className="footer-section">
            <h3>Available Types</h3>
            <ul>
              <li>T-Shirts</li>
              <li>Shirts</li>
              <li>Jeans</li>
              <li>Dresses</li>
              <li>Jackets</li>
            </ul>
          </div>

          <div className="footer-section">
            <h3>About FlopKart</h3>
            <p>
              FlopKart is your one-stop shop for trendy fashion at unbeatable
              prices. Shop smart, look sharp, and save big!
            </p>
            <p>
              Â© {new Date().getFullYear()} FlopKart â€” Built by Syed Muzakkir
            </p>
          </div>
        </div>
      </footer>
    </div>
  );
};

export default HomePage;
